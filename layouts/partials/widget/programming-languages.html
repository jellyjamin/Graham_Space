{{- $page := . -}}
{{- with .Context }}
  {{- $page = . -}}
{{- end }}
{{- $site := $page.Site -}}
{{- $yamlData := $site.Data.programming_languages -}}
{{- $fallback := dict
  "enabled" true
  "title" "Intro to Tech"
  "description" "Programming language guides and tutorials"
  "languages" (slice
    (dict
      "id" "python"
      "name" "Python"
      "slug" "intro-to-python"
      "description" "Learn Python programming from basics to advanced concepts"
      "icon" "code"
      "color" "#3776ab"
      "difficulty" "Beginner"
      "estimatedTime" "4-6 weeks"
      "mainNavigation" (dict
        "url" "/p/intro-to-python/"
        "title" "Complete Python Tutorial"
        "description" "Start your Python journey with comprehensive tutorials"
      )
      "sections" (slice
        (dict
          "id" "variables"
          "title" "Declaring variables & their naming conventions"
          "url" "/p/intro-to-python/sections/declaring-variables-naming-conventions"
          "description" "Understanding Python variables and different data types"
          "order" 1
        )
      )
    )
    (dict
      "id" "javascript"
      "name" "JavaScript"
      "slug" "intro-to-javascript"
      "description" "Master JavaScript for web development"
      "icon" "code"
      "color" "#f7df1e"
      "difficulty" "Beginner to Intermediate"
      "estimatedTime" "3-5 weeks"
      "mainNavigation" (dict
        "url" "/p/intro-to-javascript/"
        "title" "Complete JavaScript Tutorial"
        "description" "Learn JavaScript from the ground up"
      )
      "sections" (slice
        (dict
          "id" "basics"
          "title" "JavaScript Basics"
          "url" "/p/intro-to-javascript/#javascript-basics"
          "description" "Variables, operators, and basic syntax"
          "order" 1
        )
      )
    )
  )
  "customization" (dict
    "animations" (dict "duration" 300 "easing" "ease-in-out" "enable" true)
    "behavior" (dict "persistState" true "deepLinking" true "keyboardNavigation" true)
    "responsive" (dict "mobileBreakpoint" 768 "tabletBreakpoint" 1024)
  )
  "theme" (dict
    "cssPrefix" "tech-guide"
    "colors" (dict
      "primary" "var(--primary-color)"
      "secondary" "var(--secondary-color)"
      "accent" "var(--accent-color)"
      "background" "var(--background-color)"
      "text" "var(--text-color)"
      "border" "var(--border-color)"
      "hover" "var(--hover-color)"
    )
  )
) -}}
{{- $yamlDict := default dict $yamlData -}}
{{- $config := merge $fallback $yamlDict -}}
{{- $languages := coalesce $config.languages (slice) -}}
{{- $prefix := default "tech-guide" ($config.theme.cssPrefix) -}}
{{- $animations := default dict $config.customization.animations -}}
{{- $behavior := default dict $config.customization.behavior -}}
{{- $responsive := default dict $config.customization.responsive -}}
{{- $colors := default dict $config.theme.colors -}}
{{- $duration := cond (isset $animations "duration") $animations.duration 300 -}}
{{- $easing := cond (isset $animations "easing") $animations.easing "ease-in-out" -}}
{{- $animationsEnabled := cond (isset $animations "enable") $animations.enable true -}}
{{- $persistState := cond (isset $behavior "persistState") $behavior.persistState true -}}
{{- $deepLinking := cond (isset $behavior "deepLinking") $behavior.deepLinking true -}}
{{- $keyboardNav := cond (isset $behavior "keyboardNavigation") $behavior.keyboardNavigation true -}}
{{- $mobileBreakpoint := cond (isset $responsive "mobileBreakpoint") $responsive.mobileBreakpoint 768 -}}
{{- $tabletBreakpoint := cond (isset $responsive "tabletBreakpoint") $responsive.tabletBreakpoint 1024 -}}
{{- $stylePairs := slice -}}
{{- $prefixes := slice "tech-guide" -}}
{{- if ne $prefix "tech-guide" }}
  {{- $prefixes = $prefixes | append $prefix -}}
{{- end }}
{{- range $varPrefix := $prefixes }}
  {{- with $colors.primary }}{{- $stylePairs = $stylePairs | append (printf "--%s-primary: %s" $varPrefix .) -}}{{- end }}
  {{- with $colors.secondary }}{{- $stylePairs = $stylePairs | append (printf "--%s-secondary: %s" $varPrefix .) -}}{{- end }}
  {{- with $colors.accent }}{{- $stylePairs = $stylePairs | append (printf "--%s-accent: %s" $varPrefix .) -}}{{- end }}
  {{- with $colors.background }}{{- $stylePairs = $stylePairs | append (printf "--%s-background: %s" $varPrefix .) -}}{{- end }}
  {{- with $colors.text }}{{- $stylePairs = $stylePairs | append (printf "--%s-text: %s" $varPrefix .) -}}{{- end }}
  {{- with $colors.border }}{{- $stylePairs = $stylePairs | append (printf "--%s-border: %s" $varPrefix .) -}}{{- end }}
  {{- with $colors.hover }}{{- $stylePairs = $stylePairs | append (printf "--%s-hover: %s" $varPrefix .) -}}{{- end }}
{{- end }}
{{- $styleAttr := "" -}}
{{- if gt (len $stylePairs) 0 }}
  {{- $styleAttr = printf "%s;" (delimit $stylePairs "; ") -}}
{{- end }}
{{- $dataSource := cond (ne $yamlData nil) "yaml" "fallback" -}}

<div class="tech-guide-debug" style="font-size: 0.8em; color: #666; margin-top: 10px;">
  {{- if eq $dataSource "yaml" -}}
    Widget loaded from YAML with {{ len $languages }} languages
  {{- else -}}
    Widget using fallback configuration (YAML data not available)
  {{- end -}}
</div>

{{- if and $config $config.enabled (gt (len $languages) 0) -}}
<section class="widget tech-guide-widget"{{ if ne $styleAttr "" }} style="{{ $styleAttr }}"{{ end }} data-widget="programming-languages" data-prefix="{{ $prefix }}" data-data-source="{{ $dataSource }}">
  <div class="widget-icon">ðŸ“š</div>
  <h2 class="widget-title section-title">{{ $config.title }}</h2>
  {{- with $config.description }}
    <p class="widget-description">{{ . }}</p>
  {{- end }}

  <div class="tech-guide-container"
       data-duration="{{ $duration }}"
       data-easing="{{ $easing }}"
       data-animations-enabled="{{ if $animationsEnabled }}true{{ else }}false{{ end }}"
       data-persist-state="{{ if $persistState }}true{{ else }}false{{ end }}"
       data-deep-linking="{{ if $deepLinking }}true{{ else }}false{{ end }}"
       data-keyboard-nav="{{ if $keyboardNav }}true{{ else }}false{{ end }}"
       data-mobile-breakpoint="{{ $mobileBreakpoint }}"
       data-tablet-breakpoint="{{ $tabletBreakpoint }}">
    {{- range $index, $language := $languages }}
      {{- $languageIdRaw := cond (isset $language "id") $language.id (printf "language-%d" (add $index 1)) -}}
      {{- $languageId := anchorize (printf "%v" $languageIdRaw) -}}
      {{- $languageColor := cond (isset $language "color") $language.color "" -}}
      {{- $languageSlug := cond (isset $language "slug") $language.slug "" -}}
      {{- $mainNav := default dict $language.mainNavigation -}}
      {{- $mainURL := default "" $mainNav.url -}}
      {{- $isExternal := or (hasPrefix $mainURL "http://") (hasPrefix $mainURL "https://") (hasPrefix $mainURL "mailto:") (hasPrefix $mainURL "//") -}}
      {{- $mainLink := cond (eq $mainURL "") "#" (cond $isExternal $mainURL ($mainURL | relLangURL)) -}}
      {{- $sections := coalesce $language.sections (slice) -}}
      {{- $sectionsId := printf "%s-sections-%s" $prefix $languageId -}}
      {{- $sectionsLabelId := printf "%s-label" $sectionsId -}}
      <div class="tech-guide-language"
           data-language-id="{{ $languageId }}"
           {{- with $languageSlug }} data-language-slug="{{ . }}"{{ end }}
           {{- with $languageColor }} data-language-color="{{ . }}"{{ end }}>
        <div class="tech-guide-language-header">
          <a href="{{ $mainLink }}" class="tech-guide-main-link" aria-label="Go to {{ $language.name }} tutorial">
            <div class="tech-guide-language-info">
              {{- with $language.name }}
                <h3 class="tech-guide-language-name">{{ . }}</h3>
              {{- end }}
              {{- with $language.description }}
                <p class="tech-guide-language-description">{{ . }}</p>
              {{- end }}
              <div class="tech-guide-meta">
                {{- with $language.difficulty }}
                  <span class="tech-guide-difficulty difficulty-{{ lower (replace . " " "-") }}">{{ . }}</span>
                {{- end }}
                {{- with $language.estimatedTime }}
                  <span class="tech-guide-time">{{ . }}</span>
                {{- end }}
              </div>
            </div>
          </a>
          <button type="button"
                  class="tech-guide-dropdown-toggle"
                  aria-expanded="false"
                  aria-controls="{{ $sectionsId }}"
                  aria-label="Toggle {{ $language.name }} sections">
            <svg class="tech-guide-dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6,9 12,15 18,9"></polyline>
            </svg>
          </button>
        </div>
        <div class="tech-guide-sections"
             id="{{ $sectionsId }}"
             role="region"
             aria-labelledby="{{ $sectionsLabelId }}"
             hidden>
          <h4 id="{{ $sectionsLabelId }}" class="sr-only">{{ $language.name }} Tutorial Sections</h4>
          <ul class="tech-guide-section-list">
            {{- range sort $sections "order" }}
              {{- $sectionURL := default "" .url -}}
              {{- $sectionExternal := or (hasPrefix $sectionURL "http://") (hasPrefix $sectionURL "https://") (hasPrefix $sectionURL "mailto:") (hasPrefix $sectionURL "//") -}}
              {{- $sectionLink := cond (eq $sectionURL "") "#" (cond $sectionExternal $sectionURL ($sectionURL | relLangURL)) -}}
              <li class="tech-guide-section-item">
                <a href="{{ $sectionLink }}" class="tech-guide-section-link" data-section-id="{{ .id }}">
                  <div class="tech-guide-section-content">
                    {{- with .title }}
                      <span class="tech-guide-section-title">{{ . }}</span>
                    {{- end }}
                    {{- with .description }}
                      <span class="tech-guide-section-description">{{ . }}</span>
                    {{- end }}
                  </div>
                </a>
              </li>
            {{- end }}
          </ul>
        </div>
      </div>
    {{- end }}
  </div>

  <div class="tech-guide-debug" style="font-size: 0.8em; color: #666; margin-top: 10px;">
    Widget rendered with config: {{ if $config.enabled }}enabled{{ else }}disabled{{ end }} | Languages: {{ len $languages }}
  </div>
</section>
{{- else -}}
<div style="background: #c0392b; color: white; padding: 10px; margin: 5px 0;">
  Intro to Tech widget is currently disabled or has no available languages.
</div>
{{- end }}

<style>
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}
</style>
