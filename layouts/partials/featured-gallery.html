{{ $featuredPosts := where .Site.RegularPages "Params.tags" "intersect" (slice "featured") }}
{{ if $featuredPosts }}
<section class="featured-gallery">
    <h2 class="section-title">Featured Posts</h2>
    <div class="featured-posts-grid">
        {{ range $featuredPosts }}
            {{ $image := partialCached "helper/image" (dict "Context" . "Type" "featured") .RelPermalink "featured" }}
            <article class="featured-post {{ if $image.exists }}has-image{{ end }}">
                <a href="{{ .RelPermalink }}" class="featured-post-link">
                    {{ if $image.exists }}
                        <div class="featured-post-image">
                            {{ if $image.resource }}
                                {{- $imageRaw := $image.resource | resources.Fingerprint "md5" -}}
                                {{- $Permalink := $imageRaw.RelPermalink -}}
                                {{- $Width := $imageRaw.Width -}}
                                {{- $Height := $imageRaw.Height -}}

                                {{- if .Site.Params.imageProcessing.cover.enabled -}}
                                    {{- $thumbnail := $imageRaw.Fill "400x300" -}}
                                    {{- $Permalink = $thumbnail.RelPermalink -}}
                                    {{- $Width = $thumbnail.Width -}}
                                    {{- $Height = $thumbnail.Height -}}
                                {{- end -}}
                                
                                <img src="{{ $Permalink }}" 
                                    width="{{ $Width }}" 
                                    height="{{ $Height }}" 
                                    loading="lazy"
                                    alt="Featured image of post {{ .Title }}"
                                    {{ with .Slug }}data-key="{{ . }}" {{ end }}
                                    data-hash="{{ $imageRaw.Data.Integrity }}">
                            {{ else }}
                                <img src="{{ $image.permalink }}" loading="lazy" data-key="{{ .Slug }}" data-hash="{{ $image.permalink }}"/>
                            {{ end }}
                        </div>
                    {{ end }}
                    
                    <div class="featured-post-content">
                        <h3 class="featured-post-title">{{ .Title }}</h3>
                        {{ if .Summary }}
                            <p class="featured-post-summary">{{ .Summary }}</p>
                        {{ end }}
                        <div class="featured-post-meta">
                            <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                                {{ .Date.Format "Jan 2, 2006" }}
                            </time>
                            {{ if .Params.tags }}
                                <span class="featured-post-tags">
                                    {{ range first 3 .Params.tags }}
                                        <span class="tag">{{ . }}</span>
                                    {{ end }}
                                </span>
                            {{ end }}
                        </div>
                    </div>
                </a>
            </article>
        {{ end }}
    </div>
</section>
{{ end }}
